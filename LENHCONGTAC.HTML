<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªánh C√¥ng T√°c - Ph·ª• L·ª•c B (T√≠ch h·ª£p Firebase)</title>
    <style>
        body { font-family: 'Times New Roman', Times, serif; margin: 20px; font-size: 13pt; line-height: 1.5; background-color: #f4f4f4; }
        .container { max-width: 900px; margin: auto; background: white; padding: 40px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; font-size: 18pt; margin: 10px 0; text-transform: uppercase; }
        h3.section-title { background-color: #e0e0e0; padding: 5px; margin-top: 30px; border-bottom: 2px solid #333; }
        .header { text-align: center; margin-bottom: 20px; }
        .unit-name { font-weight: bold; margin-bottom: 5px; }
        
        /* Form Elements */
        label { font-weight: bold; display: block; margin-top: 10px; color: #333; }
        .inline-label { display: inline-block; margin-right: 5px; font-weight: normal; }
        input[type="text"], input[type="number"], input[type="date"], textarea { 
            width: 100%; padding: 8px; margin-top: 5px; 
            border: 1px solid #ccc; border-radius: 4px; 
            box-sizing: border-box; font-family: inherit;
        }
        textarea { height: 80px; resize: vertical; }
        
        /* Special Inputs */
        .small-input { width: 80px !important; display: inline-block !important; text-align: center; }
        .medium-input { width: 200px !important; display: inline-block !important; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #000; padding: 8px; text-align: center; vertical-align: middle; }
        th { background-color: #f0f0f0; font-weight: bold; }
        
        /* Signature Area */
        .signature-section { display: flex; justify-content: space-between; margin-top: 40px; }
        .signature-box { width: 45%; text-align: center; }
        .signature-box input { margin-top: 40px; text-align: center; border: none; border-bottom: 1px dashed #000; }

        /* Action Buttons */
        .controls { 
            position: sticky; bottom: 20px; 
            background: rgba(255,255,255,0.9); border-top: 1px solid #ddd;
            padding: 15px; text-align: center; margin-top: 30px; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 12px 25px; margin: 0 10px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            border: none; border-radius: 5px; color: white;
        }
        .btn-save { background-color: #28a745; }
        .btn-save:hover { background-color: #218838; }
        .btn-load { background-color: #007bff; }
        .btn-load:hover { background-color: #0069d9; }
        
        .status-msg { margin-top: 10px; font-style: italic; color: #d9534f; }
    </style>
</head>
<body>

    <div class="container">
        <div class="unit-name">
            T√äN ƒê∆†N V·ªä C·∫§P L·ªÜNH: <input type="text" id="donViCapLenh" class="medium-input" placeholder="Nh·∫≠p t√™n ƒë∆°n v·ªã...">
        </div>
        <div class="header">
            <h2>L·ªÜNH C√îNG T√ÅC</h2>
            <span>S·ªë: <input type="text" id="soLenh" class="small-input"></span>
        </div>

        <h3 class="section-title">A. PH·∫¶N L∆ØU GI·ªÆ C·ª¶A NG∆Ø·ªúI RA L·ªÜNH</h3>
        
        <label>1. Ng∆∞·ªùi ch·ªâ huy tr·ª±c ti·∫øp (Ng∆∞·ªùi thi h√†nh l·ªánh):</label>
        <input type="text" id="nguoiChiHuyA">
        <div style="margin-top: 5px;">
            <span class="inline-label">B·∫≠c ATƒê:</span>
            <input type="number" id="bacATDA" class="small-input" min="1" max="5"> / 5
        </div>

        <label>2. Nh√¢n vi√™n ƒë∆°n v·ªã c√¥ng t√°c:</label>
        <div style="margin-bottom: 10px;">
            <span class="inline-label">S·ªë l∆∞·ª£ng:</span> <input type="number" id="soLuongNguoiA" class="small-input"> ng∆∞·ªùi.
            <span class="inline-label">Thu·ªôc:</span> <input type="text" id="donViCongTacA" class="medium-input">
        </div>
        
        <label>Danh s√°ch nh√¢n vi√™n:</label>
        <table id="tableNhanVienA">
            <thead>
                <tr>
                    <th>TT</th>
                    <th>H·ªç v√† t√™n</th>
                    <th>B·∫≠c ATƒê</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>1</td>
                    <td><input type="text" class="staff-name-a"></td>
                    <td><input type="number" class="staff-safety-a small-input" min="1" max="5">/5</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td><input type="text" class="staff-name-a"></td>
                    <td><input type="number" class="staff-safety-a small-input" min="1" max="5">/5</td>
                </tr>
                 <tr>
                    <td>3</td>
                    <td><input type="text" class="staff-name-a"></td>
                    <td><input type="number" class="staff-safety-a small-input" min="1" max="5">/5</td>
                </tr>
            </tbody>
        </table>

        <label>3. ƒê·ªãa ƒëi·ªÉm/Thi·∫øt b·ªã c√¥ng t√°c:</label>
        <textarea id="diaDiemA"></textarea>

        <label>4. N·ªôi dung c√¥ng t√°c:</label>
        <textarea id="noiDungA"></textarea>

        <label>5. ƒêi·ªÅu ki·ªán an to√†n:</label>
        <textarea id="dieuKienA"></textarea>

        <label>6. Th·ªùi gian b·∫Øt ƒë·∫ßu (D·ª± ki·∫øn):</label>
        <input type="datetime-local" id="thoiGianBatDauA">

        <div class="signature-section">
            <div class="signature-box" style="margin-left: auto;">
                <strong>Ng∆∞·ªùi ra l·ªánh c√¥ng t√°c</strong><br>
                (K√Ω, ghi h·ªç t√™n)<br>
                <input type="text" id="nguoiRaLenhKyA" placeholder="Nh·∫≠p h·ªç t√™n...">
            </div>
        </div>

        <h3 class="section-title">B. PH·∫¶N GIAO CHO NG∆Ø·ªúI CH·ªà HUY TR·ª∞C TI·∫æP</h3>
        
        <label>1. Ng∆∞·ªùi ch·ªâ huy tr·ª±c ti·∫øp:</label>
        <input type="text" id="nguoiChiHuyB"> <label>2. Th·ªùi gian th·ª±c t·∫ø b·∫Øt ƒë·∫ßu l√†m vi·ªác:</label>
        <input type="datetime-local" id="thoiGianBatDauB">

        <label>3. K·∫øt th√∫c c√¥ng t√°c:</label>
        <div style="margin-top: 5px;">
            <span class="inline-label">ƒê√£ l√†m xong l√∫c:</span>
            <input type="datetime-local" id="thoiGianKetThuc">
        </div>

        <div class="signature-section">
            <div class="signature-box">
                <strong>Ng∆∞·ªùi ch·ªâ huy tr·ª±c ti·∫øp</strong><br>
                (K√Ω, ghi h·ªç t√™n)<br>
                <input type="text" id="nguoiChiHuyKyB">
            </div>
            <div class="signature-box">
                <strong>Ng∆∞·ªùi ra l·ªánh / Ki·ªÉm tra</strong><br>
                (K√Ω, ghi h·ªç t√™n)<br>
                <input type="text" id="nguoiRaLenhKyB">
            </div>
        </div>

    </div>

    <div class="controls">
        <input type="text" id="searchKey" placeholder="Nh·∫≠p S·ªë L·ªánh ƒë·ªÉ t√¨m ki·∫øm..." style="width: 200px; padding: 10px;">
        <button class="btn-load" onclick="loadOrder()">üîç T√¨m & Xem L·∫°i</button>
        <button class="btn-save" onclick="saveOrder()">üíæ L∆∞u L·ªánh C√¥ng T√°c</button>
        <div id="statusMessage" class="status-msg"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // ================================================================
        // 1. C·∫§U H√åNH FIREBASE 
        // B·∫†N PH·∫¢I THAY TH·∫æ PH·∫¶N N√ÄY B·∫∞NG TH√îNG TIN T·ª™ FIREBASE CONSOLE C·ª¶A B·∫†N
        // ================================================================
       const firebaseConfig = {
  apiKey: "AIzaSyBzOIDwVzfLWqg6r2wPwDyF1Cg6za8YmpE",
  authDomain: "tavnweb-a643f.firebaseapp.com",
  projectId: "tavnweb-a643f",
  storageBucket: "tavnweb-a643f.firebasestorage.app",
  messagingSenderId: "35218829332",
  appId: "1:35218829332:web:ffe14c387d2e8d403ef701"
};
        // ================================================================

        // Kh·ªüi t·∫°o Firebase
        let app;
        let db;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o!");
        } catch (error) {
            console.error("L·ªói kh·ªüi t·∫°o Firebase. Ki·ªÉm tra l·∫°i config.", error);
            document.getElementById('statusMessage').innerText = "L·ªói: Ch∆∞a c·∫•u h√¨nh Firebase ƒë√∫ng c√°ch (Xem Console).";
        }

        // --- H√ÄM L∆ØU D·ªÆ LI·ªÜU ---
        function saveOrder() {
            if (!db) { alert("Ch∆∞a k·∫øt n·ªëi Firebase!"); return; }

            const soLenh = document.getElementById('soLenh').value.trim();
            if (!soLenh) {
                alert("Vui l√≤ng nh·∫≠p 'S·ªë L·ªánh' ƒë·ªÉ l√†m kh√≥a l∆∞u tr·ªØ!");
                return;
            }

            // Thu th·∫≠p d·ªØ li·ªáu nh√¢n vi√™n t·ª´ b·∫£ng
            const staffNames = document.querySelectorAll('.staff-name-a');
            const staffSafety = document.querySelectorAll('.staff-safety-a');
            let staffList = [];
            for(let i=0; i<staffNames.length; i++) {
                if(staffNames[i].value) {
                    staffList.push({
                        name: staffNames[i].value,
                        safety: staffSafety[i].value
                    });
                }
            }

            // T·∫°o ƒë·ªëi t∆∞·ª£ng d·ªØ li·ªáu
            const orderData = {
                meta: {
                    donVi: document.getElementById('donViCapLenh').value,
                    soLenh: soLenh,
                    ngayTao: new Date().toISOString()
                },
                phanA: {
                    nguoiChiHuy: document.getElementById('nguoiChiHuyA').value,
                    bacATD: document.getElementById('bacATDA').value,
                    soLuongNguoi: document.getElementById('soLuongNguoiA').value,
                    donViCongTac: document.getElementById('donViCongTacA').value,
                    nhanVien: staffList,
                    diaDiem: document.getElementById('diaDiemA').value,
                    noiDung: document.getElementById('noiDungA').value,
                    dieuKien: document.getElementById('dieuKienA').value,
                    thoiGianBatDau: document.getElementById('thoiGianBatDauA').value,
                    nguoiRaLenhKy: document.getElementById('nguoiRaLenhKyA').value
                },
                phanB: {
                    nguoiChiHuy: document.getElementById('nguoiChiHuyB').value,
                    thoiGianBatDauThucTe: document.getElementById('thoiGianBatDauB').value,
                    thoiGianKetThuc: document.getElementById('thoiGianKetThuc').value,
                    nguoiChiHuyKy: document.getElementById('nguoiChiHuyKyB').value,
                    nguoiRaLenhKy: document.getElementById('nguoiRaLenhKyB').value
                }
            };

            // L∆∞u l√™n Firebase Realtime Database
            // D√πng 'soLenh' l√†m ID ƒë·ªÉ d·ªÖ t√¨m ki·∫øm l·∫°i
            // C·∫•u tr√∫c: lenh_cong_tac -> [so_lenh] -> data
            firebase.database().ref('lenh_cong_tac/' + soLenh).set(orderData)
                .then(() => {
                    alert("ƒê√£ l∆∞u th√†nh c√¥ng L·ªánh s·ªë: " + soLenh);
                    document.getElementById('statusMessage').innerText = "L∆∞u th√†nh c√¥ng l√∫c " + new Date().toLocaleTimeString();
                })
                .catch((error) => {
                    alert("L·ªói khi l∆∞u: " + error.message);
                });
        }

        // --- H√ÄM T·∫¢I D·ªÆ LI·ªÜU ---
        function loadOrder() {
            if (!db) { alert("Ch∆∞a k·∫øt n·ªëi Firebase!"); return; }

            const searchKey = document.getElementById('searchKey').value.trim();
            if (!searchKey) {
                // N·∫øu kh√¥ng nh·∫≠p g√¨, th·ª≠ l·∫•y t·ª´ √¥ S·ªë l·ªánh
                const currentSoLenh = document.getElementById('soLenh').value.trim();
                if(currentSoLenh) {
                    fetchData(currentSoLenh);
                } else {
                    alert("Vui l√≤ng nh·∫≠p 'S·ªë L·ªánh' v√†o √¥ t√¨m ki·∫øm ƒë·ªÉ xem l·∫°i.");
                }
                return;
            }
            fetchData(searchKey);
        }

        function fetchData(key) {
            document.getElementById('statusMessage').innerText = "ƒêang t·∫£i d·ªØ li·ªáu...";
            
            firebase.database().ref('lenh_cong_tac/' + key).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        fillForm(data);
                        document.getElementById('statusMessage').innerText = "ƒê√£ t·∫£i xong l·ªánh s·ªë " + key;
                        alert("T√¨m th·∫•y v√† ƒë√£ ƒëi·ªÅn d·ªØ li·ªáu v√†o bi·ªÉu m·∫´u.");
                    } else {
                        alert("Kh√¥ng t√¨m th·∫•y l·ªánh s·ªë: " + key);
                        document.getElementById('statusMessage').innerText = "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.";
                    }
                })
                .catch((error) => {
                    console.error(error);
                    alert("L·ªói khi t·∫£i: " + error.message);
                });
        }

        function fillForm(data) {
            // ƒêi·ªÅn l·∫°i th√¥ng tin v√†o c√°c √¥ input
            if(data.meta) {
                document.getElementById('donViCapLenh').value = data.meta.donVi || '';
                document.getElementById('soLenh').value = data.meta.soLenh || '';
            }

            if(data.phanA) {
                document.getElementById('nguoiChiHuyA').value = data.phanA.nguoiChiHuy || '';
                document.getElementById('bacATDA').value = data.phanA.bacATD || '';
                document.getElementById('soLuongNguoiA').value = data.phanA.soLuongNguoi || '';
                document.getElementById('donViCongTacA').value = data.phanA.donViCongTac || '';
                document.getElementById('diaDiemA').value = data.phanA.diaDiem || '';
                document.getElementById('noiDungA').value = data.phanA.noiDung || '';
                document.getElementById('dieuKienA').value = data.phanA.dieuKien || '';
                document.getElementById('thoiGianBatDauA').value = data.phanA.thoiGianBatDau || '';
                document.getElementById('nguoiRaLenhKyA').value = data.phanA.nguoiRaLenhKy || '';

                // ƒêi·ªÅn b·∫£ng nh√¢n vi√™n
                if(data.phanA.nhanVien && Array.isArray(data.phanA.nhanVien)) {
                    const staffNames = document.querySelectorAll('.staff-name-a');
                    const staffSafety = document.querySelectorAll('.staff-safety-a');
                    // X√≥a c≈©
                    staffNames.forEach(el => el.value = '');
                    staffSafety.forEach(el => el.value = '');
                    
                    // ƒêi·ªÅn m·ªõi
                    data.phanA.nhanVien.forEach((staff, index) => {
                        if(index < staffNames.length) {
                            staffNames[index].value = staff.name;
                            staffSafety[index].value = staff.safety;
                        }
                    });
                }
            }

            if(data.phanB) {
                document.getElementById('nguoiChiHuyB').value = data.phanB.nguoiChiHuy || '';
                document.getElementById('thoiGianBatDauB').value = data.phanB.thoiGianBatDauThucTe || '';
                document.getElementById('thoiGianKetThuc').value = data.phanB.thoiGianKetThuc || '';
                document.getElementById('nguoiChiHuyKyB').value = data.phanB.nguoiChiHuyKy || '';
                document.getElementById('nguoiRaLenhKyB').value = data.phanB.nguoiRaLenhKy || '';
            }
        }
    </script>
</body>
</html>
